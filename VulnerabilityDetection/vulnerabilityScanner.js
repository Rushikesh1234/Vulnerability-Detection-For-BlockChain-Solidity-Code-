const inquirer = require("inquirer")
const path = require('path')
const fileStatus = require('fs')
const parser = require('@solidity-parser/parser')
const validateParseCode = require('./validateParseCode')
const chalk = require('chalk')

const scan = async () => {
    fs = ''
    try {
        inquirer.registerPrompt('filePath', require('inquirer-file-path'))

        inquirer.prompt([{
            type: 'file',
            name: 'from',
            message: 'Enter File Path: '
        }]).then(function(answers) {
            fs = answers.from

            if (fs.length == 0) {
                console.log(chalk.red('Please Enter File Path for detecting vulnerability.'))
                process.exit()
            }
            if (fileStatus.existsSync(fs) == false) {
                console.log(chalk.red('Please Enter Valid Path.'))
                process.exit()
            }
            if (path.extname(fs) != '.sol') {
                console.log(chalk.red('Scanner only validates .sol file.'))
                process.exit()
            }

            data = fileStatus.readFileSync(fs, { encoding: 'utf8', flag: 'r' }).toString()

            console.log('\n')
            console.log(chalk.cyan('Parsing Code...'))
            const parseData = parser.parse(data)

            console.log(chalk.green('Parsing is completed. Checking vulnerability in solidity code...'))
            validateParseCode.checkPatterns(parseData)

            console.log(chalk.white('Do you want to download report in your system? Enter Yes/No'))
        })
    } catch (err) {
        console.log(chalk.red(err))
    }
}

scan()